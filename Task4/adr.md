# ADR: Критерии выбора архитектурного решения

**Дата:** 11.12.2025  
**Автор:** Валерий

---

# 1. Контекст

### **Вариант A — MVP**

Web Portal, Auth, Ingest, Processor, RabbitMQ, TSDB/S3, Notification, Monitoring.

### **Вариант B — Масштабируемая потоковая архитектура**

API Gateway, Auth, IoT Gateway, Kafka, Stream Processing, TimeSeries DB, S3 Storage, Notification, BI, Monitoring.

---

# 2. Критерии оценки

| №   | Критерий                                       | Описание                                                |
| --- | ---------------------------------------------- | ------------------------------------------------------- |
| 1   | **Стоимость внедрения**                        | Сложность разработки, поддержка, лицензии               |
| 2   | **Скорость вывода MVP**                        | Время запуска первой версии                             |
| 3   | **Масштабируемость**                           | Горизонтальное масштабирование и пропускная способность |
| 4   | **Надёжность и отказоустойчивость**            | SLA 99.95%, устойчивость к потере сообщений             |
| 5   | **Поддержка оффлайна**                         | Работа фермы в офлайне, задержки синхронизации          |
| 6   | **Реакция видеоаналитики (<5 сек)**            | Скорость обработки событий                              |
| 7   | **Интеграция IoT (MQTT, разнородные датчики)** | Удобство подключения оборудования                       |
| 8   | **Простота поддержки команды**                 | Наличие экспертизы, трудность DevOps                    |
| 9   | **Готовность к SaaS расширению**               | Возможность мультитенантности в будущем                 |
| 10  | **Зависимость от технологий**                  | Возможные ограничения выбранного стека                  |

---

# 3. Анализ решения A — Lightweight MVP

Преимущества:

- Минимальная стоимость разработки.
- Быстрое создание MVP.
- RabbitMQ проще, чем Kafka, и лучше для небольших очередей.
- Хорош для начального запуска.
- Низкий порог входа для команды.

Недостатки:

- RabbitMQ не лучший выбор для больших нагрузок.
- Нет event streaming - аналитика ограничена.
- Менее подходящая архитектура для SaaS в будущем.
- Тяжелее масштабировать при резком росте устройств.

### Итоги по критериям

| Критерий         | Оценка | Комментарий                            |
| ---------------- | ------ | -------------------------------------- |
| Стоимость        | 5      | Самая дешёвая реализация               |
| Скорость MVP     | 5      | Минимум компонентов                    |
| Масштабируемость | 2      | Упирается в RabbitMQ и CPU             |
| Надёжность       | 4      | До 2-3т./сек - Ок                      |
| Оффлайн          | 4      | Реализуемо на Ingest + локальный агент |
| <5 сек реакция   | 5      | Малое количество промежуточных узлов   |
| IoT интеграции   | 4      | MQTT через мост                        |
| Поддержка        | 5      | Команда легко поддержит                |
| SaaS потенциал   | 2      | Придётся переделывать половину         |
| Vendor-lock      | 4      | Минимальный                            |

---

# 4. Анализ решения B — Потоковая архитектура

Преимущества:

Kafka обеспечивает высокую пропускную способность и долговременное хранение.
Лучшая основа для SaaS и мультитенантности.
Гибкость стриминговой аналитики (Flink/Kafka Streams).
Готово к росту для Saas.

Недостатки:

Повышенная стоимость DevOps (Kafka, Zookeeper/KRaft, kafkagateways).
Дольше вывод MVP.
Нужна экспертиза по стримингу.
Нужно грамотное мониторинговое покрытие.

### Итоги по критериям

| Критерий         | Оценка | Комментарий                             |
| ---------------- | ------ | --------------------------------------- |
| Стоимость        | 2      | Kafka и Flink требуют инфраструктуры    |
| Скорость MVP     | 2      | Большой объём работ                     |
| Масштабируемость | 5      | Лидер по нагрузке                       |
| Надёжность       | 5      | Репликация, ретеншн, устойчивость       |
| Оффлайн          | 4      | Нужно разворачивать lightweight gateway |
| <5 сек реакция   | 5      | Stream processing подходит идеально     |
| IoT интеграции   | 5      | MQTT -> Kafka - промышленный стандарт   |
| Поддержка        | 2      | Требуется DevOps                        |
| SaaS потенциал   | 5      | Идеальная основа                        |
| Vendor-lock      | 3      | Привязка к Kafka/Confluent              |

---

# 5. Сравнительная таблица A vs B

| Критерий              | A — Lightweight MVP | B — Scalable Streaming |
| --------------------- | ------------------- | ---------------------- |
| Стоимость             | 5                   | 2                      |
| Быстрый MVP           | 5                   | 2                      |
| Масштабируемость      | 2                   | 5                      |
| Надёжность            | 4                   | 5                      |
| Видеоаналитика <5 сек | 5                   | 5                      |
| IoT интеграции        | 4                   | 5                      |
| Поддержка             | 5                   | 2                      |
| SaaS готовность       | 2                   | 5                      |
| Риск vendor-lock      | 4                   | 3                      |

---

# 6. Рекомендация

Рекомендуемое решение: Вариант A для MVP.

Причины:

Дешевле, быстрее, проще развернуть.
Позволяет показать ценность бизнесу за 2-3 месяца.
Выполняет требования: офлайн-режим, видеоаналитика, уведомления.


При этом архитектура должна учитывать будущую миграцию:

Использовать event-first подход.
Сделать прием данных и процессор так, чтобы при необходимости заменить RabbitMQ на Kafka.

Вариант B рекомендуется как целевая архитектура для SaaS.


---

# 7. Решение

Применить Вариант A как MVP и заложить совместимость с будущей миграцией в Kafka. 
