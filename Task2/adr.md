# ADR 002 — Контейнерная архитектура: RabbitMQ (MVP) vs Kafka (Scale)

_Дата:_ 11.12.2025
_Автор:_ Валерий

## Статус

Принято временно (MVP) / Альтернатива зафиксирована (для масштабирования)

## Контекст и проблема

Платформа должна собирать телеметрию от IoT-шлюзов и видеоаналитики, обрабатывать события в реальном времени и доставлять уведомления пользователям с задержкой не более 5 секунд. Нагрузка на систему пока неизвестна: ожидается стартаповый рост от одной–двух ферм до десятков.

Нужно выбрать стек контейнеров и шину сообщений, которые обеспечат быстрый выход на рынок (MVP) и путь к масштабированию без полного рефакторинга.

## Варианты решений

### Вариант A (Основной) - RabbitMQ + микросервисы + TimescaleDB

- RabbitMQ как очередь сообщений с MQTT bridge для устройств.
- Небольшой набор микросервисов: Ingest - Processor - Notification - API Gateway - UI.
- TimescaleDB для временных рядов; S3 для видео.

**Преимущества:**

- Простота разработки и эксплуатации.
- Поддержка MQTT через bridge; низкие задержки при умеренных нагрузках.
- Быстрый MVP rollout.

**Недостатки / Риски:**

- При значительном росте сообщений (миллионы событий/мин) RabbitMQ может стать узким местом.
- Нужна чёткая стратегия горизонтального масштабирования и шардинга очередей.

**Компромиссы:**

- Выбор RabbitMQ ускоряет релиз и снижает TCO на ранней стадии, но добавляет риск дополнительных работ по миграции на Kafka позже.
- MQTT bridge в RabbitMQ упрощает интеграцию IoT устройств, но добавляет дополнительный слой абстракции.
- Использование TimescaleDB для временных рядов оптимизировано для метрик, но менее гибко для произвольных запросов по сравнению с ClickHouse.

[С2 - основное решение](c2_main.puml)

### Вариант B (Альтернативный) - Apache Kafka + Stream Processing

- Kafka как основная шина событий.
- Stream processing (Kafka Streams / Flink) для real-time логики.
- ClickHouse / Timescale для аналитики, S3 для видео.

**Преимущества:**

- Высокая пропускная способность и устойчивость к пиковым нагрузкам.
- Упрощённое повторное воспроизведение событий (replay) и интеграция с ML пайплайнами.

**Недостатки / Риски:**

- Сложность эксплуатации и более высокий OPEX / DevOps порог.
- Дороже на старте.

**Компромиссы:**

- Kafka обеспечивает высокую пропускную способность (миллионы событий/мин) и горизонтальное масштабирование, но требует опытной DevOps команды и увеличивает стоимость ввода в эксплуатацию.
- Stream processing (Flink/Kafka Streams) позволяет сложную обработку событий в реальном времени, но усложняет отладку и тестирование.
- ClickHouse предоставляет мощные аналитические запросы, но требует больше ресурсов и экспертизы для оптимизации.

[С2 - альтернативное решение](c2_alt.puml)

## Точки принятия решения

- Время до MVP: критично - преимущество RabbitMQ
- Ожидаемая нагрузка в 6–12 мес: если >2-3к/сек - рассмотреть Kafka
- Команда DevOps: малый штат - RabbitMQ; опытный DevOps - Kafka возможен

## План миграции при RabbitMQ

1. Внедрить RabbitMQ с ясной схемой топиков и контрактов событий.
2. При достижении порога нагрузки - миграция топиков на Kafka.

## Открытые вопросы

- Точечный SLA на доставку оповещений для разных ролей (директор vs механик).
- Детали хранения видео: сроки хранения и модель затрать (S3 vs холодное хранилище).
