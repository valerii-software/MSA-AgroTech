# ADR 005 - Мультитенантная архитектура

_Дата:_ 11.12.2025
_Автор:_ Валерий

## Контекст

После внедрения MVP на собственных фермах компания планирует вывести решение как коммерческую SaaS-платформу для других агрохолдингов.

## Цели бизнеса

- Создать новый источник регулярного дохода.
- Уменьшить TCO для клиентов за счёт облачной модели.
- Ускорить выход на рынок и масштабирование.
- Собрать данные для создания собственных ML-моделей.

### Вызовы специфики агротеха

- Отсутствие готовых SaaS-решений для животноводства в открытом доступе.
- Необходимость работы в условиях нестабильного интернета на фермах.
- Интеграция с российскими платёжными системами.
- Большие объёмы видеоданных (от камер видеонаблюдения).
- Требования к изоляции данных в конкурентной среде.

---

## Варианты решений для мультитенантности

### Вариант A: Изоляция на уровне схем БД (Schema-per-tenant)

**Архитектура:**

- Единая база данных PostgreSQL/TimescaleDB
- Отдельная схема для каждого клиента (tenant)
- Общие сервисы с tenant_id в контексте запроса
- Row-Level Security (RLS) для дополнительной защиты

**Компоненты:**

- Tenant Router в API Gateway для определения tenant_id из токена/домена
- Единый Connection Pool с переключением search_path
- Общая инфраструктура мониторинга и бэкапов

**Преимущества:**

- Минимальные затраты на инфраструктуру
- Простота управления миграциями (одна миграция на все схемы)
- Эффективное использование ресурсов
- Простота кросс-tenant аналитики для ML-моделей
- Быстрая онбординг новых клиентов (CREATE SCHEMA)

**Недостатки и риски:**

- Слабая изоляция: ошибка в коде может привести к утечке данных между клиентами
- Шумные соседи: активный клиент может замедлить всех
- Сложность масштабирования: нельзя разнести клиентов по разным серверам
- Ограничения по размеру БД PostgreSQL (+-2TB)
- Риск регуляторных проблем при инцидентах безопасности

**Критерии применимости:**

- До 50-100 клиентов
- Клиенты с примерно одинаковой нагрузкой
- Низкие требования к физической изоляции данных
- Стартап-фаза с ограниченным бюджетом

---

### Вариант B: Изоляция на уровне отдельных БД (Database-per-tenant)

**Архитектура:**

- Отдельная база данных для каждого клиента на общем кластере PostgreSQL
- Tenant Router направляет запросы на соответствующую БД
- Connection Pool per tenant с ограничением ресурсов
- Возможность шардинга крупных клиентов

**Компоненты:**

- Tenant Registry Service: маппинг tenant_id:DB_connection_string
- Database Provisioner: автоматическое создание БД для новых клиентов
- Backup Orchestrator: координация бэкапов множества БД
- Resource Governor: контроль лимитов CPU/memory per tenant

**Преимущества:**

- Хорошая изоляция: каждый клиент в отдельной БД
- Гибкость масштабирования: легко перенести БД на другой сервер
- Изоляция шумных соседей: проблемы одного клиента не влияют на других
- Проще соответствие регуляторным требованиям
- Возможность разных версий схемы для разных клиентов

**Недостатки и риски:**

- Сложность управления миграциями: нужно мигрировать каждую БД
- Больше накладных расходов на соединения и мониторинг
- Сложнее кросс-tenant аналитика
- Риск достижения лимита баз данных в кластере
- Больше времени на онбординг (создание БД, применение миграций)

**Критерии применимости:**

- 50-500 клиентов
- Разнородная нагрузка (есть крупные и мелкие клиенты)
- Средние требования к изоляции
- Средний бюджет на инфраструктуру

---

### Вариант C: Изоляция на уровне инстансов (Instance-per-tenant)

**Архитектура:**

- Полностью изолированный стек для каждого клиента или группы клиентов
- Отдельные кластеры PostgreSQL, RabbitMQ, кэши, S3 buckets
- Kubernetes namespace per tenant или отдельные кластеры
- Возможность deployment в облаке клиента или on-premise

**Компоненты:**

- Infrastructure as Code (Terraform/Pulumi) для автоматизации
- Tenant Orchestrator: управление жизненным циклом инстансов
- Centralized Billing & Analytics Collector
- Multi-cluster Management Platform (Rancher/Lens)

**Преимущества:**

- Максимальная изоляция: полная независимость клиентов
- Кастомизация под конкретного клиента (версии, конфигурация)
- Соответствие строгим регуляторным требованиям
- Возможность on-premise deployment для крупных клиентов
- Полная изоляция шумных соседей
- Географическое распределение (ЦОД в регионах клиентов)

**Недостатки и риски:**

- Очень высокие операционные затраты
- Сложность управления множеством инстансов
- Неэффективное использование ресурсов
- Долгий онбординг
- Практически невозможна кросс-tenant аналитика
- Высокие требования к DevOps

**Критерии применимости:**

- Enterprise-клиенты со строгими требованиями к безопасности
- Регуляторные требования к физической изоляции
- On-premise или hybrid cloud сценарии
- Высокий бюджет на инфраструктуру и операции

---

## Гибридный подход (Рекомендация)

Учитывая специфику агротеха и разнообразие потенциальных клиентов, рекомендуется **гибридный подход**:

### Малые клиенты (до 5 ферм) - Вариант A (Schema-per-tenant)

- Общая БД с изоляцией на уровне схем
- Стандартный тарифный план
- Быстрый онбординг

### Средние клиенты (5-20 ферм) - Вариант B (Database-per-tenant)

- Выделенная БД на общем кластере
- Гибкие тарифы
- Возможность кастомизации

### Крупные клиенты (20+ ферм) - Вариант C (Instance-per-tenant)

- Выделенная инфраструктура
- Enterprise SLA
- On-premise опция

---

## Точки принятия решения

| Критерий                       | Вариант A (Schema) | Вариант B (Database) | Вариант C (Instance) |
| ------------------------------ | ------------------ | -------------------- | -------------------- |
| **Стоимость инфраструктуры**   | 5/5 (низкая)       | 3/5 (средняя)        | 1/5 (высокая)        |
| **Изоляция данных**            | 2/5 (слабая)       | 4/5 (хорошая)        | 5/5 (отличная)       |
| **Масштабируемость**           | 2/5 (ограничена)   | 4/5 (хорошая)        | 5/5 (отличная)       |
| **Скорость онбординга**        | 5/5 (секунды)      | 3/5 (минуты)         | 1/5 (часы/дни)       |
| **Управляемость**              | 5/5 (простая)      | 3/5 (средняя)        | 1/5 (сложная)        |
| **Кросс-tenant аналитика**     | 5/5 (легко)        | 3/5 (сложнее)        | 1/5 (очень сложно)   |
| **Кастомизация**               | 1/5 (нет)          | 3/5 (ограничена)     | 5/5 (полная)         |
| **Защита от "шумных соседей"** | 1/5 (слабая)       | 3/5 (средняя)        | 5/5 (полная)         |

---

## Решение

**Принято:** Гибридный подход с начальной реализацией Варианта B (Database-per-tenant) как базового.

**Обоснование:**

1. Вариант B обеспечивает баланс между изоляцией и стоимостью
2. Позволяет масштабироваться до 500 клиентов без фундаментальной перестройки
3. Путь миграции вниз (к Варианту A для микроклиентов) и вверх (к Варианту C для enterprise) относительно прост
4. Соответствует ожиданиям рынка агротеха по безопасности данных

**Стратегия внедрения:**

- **Фаза 1 (0-6 мес):** Вариант B для всех клиентов, отладка процессов
- **Фаза 2 (6-12 мес):** Добавление Варианта A для микроклиентов (< 2 ферм)
- **Фаза 3 (12-18 мес):** Добавление Варианта C для enterprise-клиентов

---

## Последствия

### Положительные

- Четкий путь масштабирования от стартапа до enterprise
- Гибкость ценообразования под разные сегменты
- Достаточная изоляция для большинства клиентов
- Управляемая сложность DevOps

### Отрицательные

- Необходимость поддержки трёх моделей изоляции увеличивает сложность
- Требуется инвестиция в инструменты автоматизации (DB provisioning, migrations)
- Кросс-tenant аналитика потребует отдельного аналитического хранилища

### Риски

- **Переоценка сложности миграций:** потребуется robust tooling для миграции тысяч БД
- **Достижение лимитов кластера:** нужен мониторинг количества БД и план шардинга
- **Регуляторные изменения:** могут потребовать перехода на Вариант C для всех

---

## Компромиссы

1. **Сложность vs Гибкость:** Принимаем большую операционную сложность ради гибкости предложения для разных сегментов
2. **Стоимость vs Изоляция:** Отказываемся от максимальной изоляции (Вариант C) для большинства клиентов ради приемлемой стоимости
3. **Кросс-tenant аналитика vs Изоляция:** Принимаем сложности с аналитикой при Варианте B ради лучшей изоляции

---

## Связанные решения

- ADR 004: Критерии выбора архитектурного решения MVP
- ADR 002: Контейнерная архитектура (RabbitMQ vs Kafka)
- ADR 006 (следующий): Система биллинга и монетизации
- ADR 007 (следующий): API для клиентов SaaS-платформы

---

## Дополнительная информация

### Диаграммы

- [C2: Database-per-tenant (основной вариант)](c2_db_per_tenant.puml)
- [C3: Schema-per-tenant (для микроклиентов)](c3_schema_per_tenant.puml)
- [C2: Instance-per-tenant (для enterprise)](c2_instance_per_tenant.puml)
- [C1: Финальная архитектура SaaS-платформы](c1_saas_final.puml)
- [C2: Финальная архитектура SaaS-платформы](c2_saas_final.puml)
- [C2: Интеграция с текущей компанией как клиентом](c2_integration_current_company.puml)

### Технологические решения

**Tenant Registry:**

- PostgreSQL для хранения маппинга tenant - database
- Redis для кэширования маппинга
- Consul для service discovery

**Database Provisioning:**

- Terraform для автоматизации создания БД
- Liquibase/Flyway для миграций
- Ansible для конфигурации

**Connection Management:**

- PgBouncer в режиме transaction pooling
- HikariCP на уровне приложения с tenant-aware configuration

**Мониторинг:**

- Prometheus per tenant с federation
- Grafana с multi-tenant dashboards
- AlertManager с tenant-specific routing
