# ADR 001 — Контекстная архитектура

_Дата:_ 10.12.2025
_Автор:_ Валерий

### Функциональные требования

| **№** | **Действующие лица или системы** | **Use Case**          | **Описание**                                                              |
| :---: | :------------------------------- | :-------------------- | :------------------------------------------------------------------------ |
|   1   | Директор хозяйства               | Управление платформой | Доступ к порталу для мониторинга состояния поголовья, техники и аналитики |
|   2   | Механик                          | Мониторинг техники    | Отслеживает состояние техники, реагирует на неисправности                 |
|   3   | Аналитик                         | Анализ данных         | Собирает и анализирует метрики, строит отчеты                             |
|   4   | Дежурный сотрудник платформы     | Управление платформой | Следит за исправностью платформы и реагирует на сбои                      |

### Нефункциональные требования

| **№** | **Требование**                                                                                                                                |
| :---: | :-------------------------------------------------------------------------------------------------------------------------------------------- |
|   1   | обеспечивать отказоустойчивость **99,95%**                                                                                                    |
|   2   | быть расширяемой (новый функционал без изменений существующего)                                                                               |
|   3   | иметь высокую производительность: от момента фиксации нештатной ситуации видеоаналитикой до оповещения должно проходить не более **5 секунд** |
|   4   | обеспечивать реакцию видеоаналитики в реальном времени (миллисекунды)                                                                         |

### Решение

Контур платформы включает:

**Инфраструктура:**

- Свинофермы (№1, №2, ...) с IP-камерами, IoT датчиками
- Edge устройства на каждой ферме для локальной обработки видео и данных
- Облачная инфраструктура (YandexCloud) с центральной платформой мониторинга
- Внешний сервис видеоаналитики для ML-обработки

**Участники:**

- Дежурный сотрудник платформы (в облаке)
- Платформа для мониторинга скота (центральная система)
- Директор, Механик, Аналитик как пользователи

**Логика:**

- Edge устройства собирают данные с камер (RTSP) и датчиков (MQTT/HTTP), выполняют первичную обработку
- Обработанные события и метрики отправляются в облако через Интернет (HTTPS/MQTT)
- Платформа агрегирует данные, запрашивает анализ видео у внешнего сервиса
- Директор и аналитик получают доступ к дашбордам, механик реагирует на неисправности
- Edge устройства могут работать автономно при потере связи с облаком

**Технологический выбор:**

- Edge обработка для снижения нагрузки на канал и автономности ферм
- Единая облачная платформа для агрегации и обработки данных
- Внешний сервис видеоаналитики для использования готовых ML-моделей
- Простая архитектура для MVP с минимальными внешними зависимостями

**Компромиссы:**

- Выбор Edge обработки увеличивает стоимость оборудования на фермах, но снижает требования к каналу связи
- Централизованная платформа упрощает управление, но создаёт единую точку отказа
- Использование внешнего сервиса видеоаналитики ускоряет запуск MVP, но создаёт зависимость от поставщика

**Риски:**

- При отказе Интернета на ферме Edge устройство не сможет отправлять критические уведомления в реальном времени
- Облачная платформа может стать узким местом при масштабировании на десятки ферм
- Внешний сервис видеоаналитики может иметь ограничения по пропускной способности или доступности
- Задержки в сети могут превысить целевые 5 секунд для доставки уведомлений

[С1 - Основное решение](c1_main.puml)

### Альтернативы

Контур платформы расширен отдельной обработкой данных и специализированными системами:

**Инфраструктура:**

- Свинофермы с IP-камерами, IoT датчиками и IoT-шлюзами (Node-RED на Edge устройствах)
- Облачная инфраструктура с разделением на компоненты:
  - Apache Kafka как центральная шина данных
  - Платформа для обработки событий и инцидентов
  - BI-система (Power BI) для аналитики и отчетности
- Внешний сервис видеоаналитики

**Участники:**

- Дежурный сотрудник и механик работают с платформой мониторинга
- Директор и аналитик используют BI-систему для отчетности

**Логика:**

- IoT-шлюзы на фермах собирают данные с камер и датчиков, выполняют локальную обработку и фильтрацию
- Шлюзы публикуют события в Kafka (центральную шину данных)
- Платформа мониторинга подписывается на события из Kafka, обрабатывает инциденты
- BI-система получает потоковые данные из Kafka для аналитики и отчётов
- При потере связи с облаком IoT-шлюз может локально сохранять критические события и воспроизвести их после восстановления

**Преимущества:**

- Высокая масштабируемость через Kafka (миллионы событий/мин)
- Разделение обработки данных (платформа) и визуализации/аналитики (BI)
- Возможность повторного воспроизведения событий (replay) для отладки и аудита
- Гибкость для будущей SaaS-архитектуры и подключения множества ферм
- IoT-шлюзы обеспечивают буферизацию при проблемах с сетью

**Компромиссы:**

- Более высокая сложность инфраструктуры увеличивает время до MVP
- Kafka требует опытной DevOps команды и увеличивает издержки
- Разделение на платформу и BI создаёт два интерфейса для разных ролей, что усложняет обучение
- Стоимость Edge устройств с Node-RED выше, чем простые IoT-хабы

**Риски:**

- Сложность эксплуатации Kafka может привести к проблемам при малом DevOps штате
- Возможное дублирование данных между платформой и BI увеличивает затраты на хранение
- При отказе Kafka вся система теряет центральную точку коммуникации
- Требуется стабильное соединение между фермами и облаком для работы в реальном времени
- IoT-шлюзы с ограниченной памятью могут переполниться при длительных сбоях связи

[С1 - альтернативное решение](c1_alt.puml)
